parameters:
  env(DEFAULT_PERMISSIONS_DIR_MODE): null
  env(DEFAULT_PERMISSIONS_FILE_MODE): null
  env(CONFIG_CACHE_CACHE): false

  env_name: '%env(string:ENV_NAME)%'
  env_type: '%env(string:ENV_TYPE)%'
  env_url: '%env(string:ENV_URL)%'
  max_upload_file_size_mb: 5
  config_cache: '%env(bool:CONFIG_CACHE_CACHE)%'

services:
  _defaults:
    public: true
    bind:
      $fallbackLocale: '%default_locale%'
      $siteUrl: '%env_url%'

  ExEss\Cms\Component\Session\Headers:
    class: ExEss\Cms\Component\Session\Headers
    factory: [ 'ExEss\Cms\Component\Session\Headers', 'create' ]

  ExEss\Cms\Logger\Logger:
    arguments:
      - '@monolog.logger'

  ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer:
    lazy: true
    factory: [ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer, get]

  Symfony\Component\EventDispatcher\EventDispatcher:
    class: Symfony\Component\EventDispatcher\EventDispatcher
    factory: [ExEss\Cms\Api\V8_Custom\Service\EventDispatcherFactory, getEventDispatcher]
    arguments:
      - '@service_container'
      - !tagged { tag: 'crm.subscriber', index_by: 'key' }

  Symfony\Component\EventDispatcher\EventDispatcherInterface: '@Symfony\Component\EventDispatcher\EventDispatcher'
  event_dispatcher: '@Symfony\Component\EventDispatcher\EventDispatcher'

  ExEss\Cms\Component\Flow\Event\FlowEventDispatcher:
    arguments:
      - '@Symfony\Component\EventDispatcher\EventDispatcher'
      - '@ExEss\Cms\Component\Flow\Action\BackendCommandExecutor'

  ExEss\Cms\Component\Flow\Validator:
    class: ExEss\Cms\Component\Flow\Validator
    lazy: true
    arguments:
      - '@Symfony\Component\Validator\Validator\ValidatorInterface'
      - '@ExEss\Cms\Validators\Factory\ConstraintFactory'
      - '@ExEss\Cms\Logger\Logger'
      - '@ExEss\Cms\Component\ExpressionParser\ParserService'
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer'

  ExEss\Cms\Component\Flow\FlowValidator:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Component\Flow\Validator'
      - '@ExEss\Cms\Service\GridService'

  ExEss\Cms\Component\Health\PingService: ~

  ExEss\Cms\Config\Cache\ConfigCacheFactory:
    arguments:
      - '%config_cache%'
      - '@=service(constant("ExEss\\Bundle\\CmsBundle\\Component\\Cache\\Dictionary::CONFIG"))'
      - '@ExEss\Cms\Component\ExpressionParser\ParserService'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'

  ExEss\Cms\Users\Service\GuidanceRecoveryService:
    arguments:
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'
      - '@doctrine.orm.entity_manager'

  ExEss\Cms\Api\V8_Custom\Service\Security:
    lazy: true
    arguments:
      - '@security.token_storage'
      - '%default_locale%'

  ExEss\Cms\Component\Flow\DefaultValueService:
    arguments:
      - '@ExEss\Cms\MultiLevelTemplate\TextFunctionHandler'

  ExEss\Cms\Cleaner\HtmlCleaner:
    arguments:
      - '%env_url%'
      - '%kernel.cache_dir%/htmlcleaner'

  JsonMapper:
    class: JsonMapper
    factory: [ExEss\Cms\Factory\JsonMapperFactory, create]

  ExEss\Cms\Component\Flow\Builder\FormBuilder:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Component\Flow\Builder\EnumFieldBuilder'
      - '@ExEss\Cms\Component\ExpressionParser\ParserService'
      - '@ExEss\Cms\Service\SelectWithSearchService'
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'
      - '@ExEss\Cms\Component\Flow\Field'

  ExEss\Cms\Component\Flow\Field:
    arguments:
      - '%max_upload_file_size_mb%'

  ExEss\Cms\Component\Flow\Builder\EnumFieldBuilder:
    lazy: true
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Logger\Logger'
      - '@ExEss\Cms\Api\V8_Custom\Repository\ListHandler'
      - '@ExEss\Cms\Component\Flow\EnumRecordFactory'
      - '@ExEss\Cms\Service\SelectWithSearchService'

  ExEss\Cms\Component\Sidebar\Factory\SidebarFactory: ~

  ExEss\Cms\Api\V8_Custom\Service\User\CommandService:
    arguments:
      - '@ExEss\Cms\Users\Service\GuidanceRecoveryService'

  ExEss\Cms\FieldFormatter\VatNumberFormatter: ~

  libphonenumber\PhoneNumberUtil:
    class: libphonenumber\PhoneNumberUtil
    factory: [libphonenumber\PhoneNumberUtil, getInstance]

  ExEss\Cms\FieldFormatter\PhoneNumberFormatter:
    arguments:
      - 'BE'
      - '@libphonenumber\PhoneNumberUtil'

  ExEss\Cms\FieldFormatter\IbanFormatter: ~

  ExEss\Cms\Api\V8_Custom\Service\SimpleActionFactory:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Logger\Logger'

  ExEss\Cms\Component\Flow\ActionFactory:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Component\Flow\Event\FlowEventDispatcher'
      - '@ExEss\Cms\Logger\Logger'
      - '@Symfony\Component\Translation\Translator'

  ExEss\Cms\Component\Flow\EnumRecordFactory:
    arguments:
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'

  ExEss\Cms\MultiLevelTemplate\TextFunctionHandler:
    arguments:
      - '@ExEss\Cms\Logger\Logger'
      - '@Symfony\Component\Translation\Translator'

  ExEss\Cms\Http\Factory\PsrFactory: ~

  ExEss\Cms\Http\Factory\JsonBodyFactory:
    autowire: true

  # Autowired Service directory
  ExEss\Cms\Service\:
    public: true
    autowire: true
    resource: '../../src/ExEss/Cms/Service/'

imports:
  - { resource: 'api_client_external.yaml' }
  - { resource: 'api_client_internal.yaml' }
  - { resource: 'backendCommands.yaml' }
  - { resource: 'commands.yaml' }
  - { resource: 'converters.yaml' }
  - { resource: 'database.yaml' }
  - { resource: 'handlers.yaml' }
  - { resource: 'health.yaml' }
  - { resource: 'logging.yaml' }
  - { resource: 'repositories.yaml' }
  - { resource: 'security.yaml' }
  - { resource: 'subscribers.yaml' }
  - { resource: 'suggestions.yaml' }
  - { resource: 'translators.yaml' }
  - { resource: 'validation.yaml' }
  - { resource: 'entity_listeners.yaml' }
  - { resource: 'component/expression_parser.yaml' }
