parameters:
  env(DEFAULT_PERMISSIONS_DIR_MODE): null
  env(DEFAULT_PERMISSIONS_FILE_MODE): null
  env(CONFIG_CACHE_CACHE): false

  env_name: '%env(string:ENV_NAME)%'
  env_type: '%env(string:ENV_TYPE)%'
  env_url: '%env(string:ENV_URL)%'
  max_upload_file_size_mb: 5
  config_cache: '%env(bool:CONFIG_CACHE_CACHE)%'

services:
  _defaults:
    public: true

  ExEss\Cms\Component\Session\Headers:
    class: ExEss\Cms\Component\Session\Headers
    factory: [ 'ExEss\Cms\Component\Session\Headers', 'create' ]

  ExEss\Cms\Logger\Logger:
    arguments:
      - '@monolog.logger'

  ExEss\Cms\Api\V8_Custom\Service\RequestResponseLogger:
    arguments:
      - '@monolog.logger.request'

  ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer:
    lazy: true
    factory: [ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer, get]
    arguments:
      - '@Symfony\Component\Translation\Translator'

  Symfony\Component\EventDispatcher\EventDispatcher:
    class: Symfony\Component\EventDispatcher\EventDispatcher
    factory: [ExEss\Cms\Api\V8_Custom\Service\EventDispatcherFactory, getEventDispatcher]
    arguments:
      - '@service_container'
      - !tagged { tag: 'crm.subscriber', index_by: 'key' }

  Symfony\Component\EventDispatcher\EventDispatcherInterface: '@Symfony\Component\EventDispatcher\EventDispatcher'
  event_dispatcher: '@Symfony\Component\EventDispatcher\EventDispatcher'

  ExEss\Cms\FLW_Flows\Event\FlowEventDispatcher:
    class: ExEss\Cms\FLW_Flows\Event\FlowEventDispatcher
    arguments:
      - '@Symfony\Component\EventDispatcher\EventDispatcher'

  ExEss\Cms\FLW_Flows\Validator:
    class: ExEss\Cms\FLW_Flows\Validator
    lazy: true
    arguments:
      - '@Symfony\Component\Validator\Validator\ValidatorInterface'
      - '@ExEss\Cms\Validators\Factory\ConstraintFactory'
      - '@ExEss\Cms\Logger\Logger'
      - '@ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions'
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer'

  ExEss\Cms\FLW_Flows\FlowValidator:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\FLW_Flows\Validator'
      - '@ExEss\Cms\Dashboard\GridRepository'

  ExEss\Cms\JsonValidator\JsonValidator: ~

  ExEss\Cms\Component\Health\PingService: ~

  ExEss\Cms\Config\Cache\ConfigCacheFactory:
    arguments:
      - '%config_cache%'
      - '@=service(constant("ExEss\\Cms\\Cache\\Cache::CONFIG"))'
      - '@ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'

  ExEss\Cms\Users\Service\GuidanceRecoveryService:
    arguments:
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'
      - '@doctrine.orm.entity_manager'

  ExEss\Cms\Api\V8_Custom\Service\Security:
    lazy: true
    arguments:
      - '@security.token_storage'
      - '%default_locale%'

  ExEss\Cms\FLW_Flows\DefaultValueService:
    arguments:
      - '@ExEss\Cms\MultiLevelTemplate\TextFunctionHandler'

  ExEss\Cms\Cleaner\HtmlCleaner:
    arguments:
      - '%env_url%'
      - '%kernel.cache_dir%/htmlcleaner'

  ExEss\Cms\Component\Health\Serializer\Normalizer\HealthCheckResultNormalizer: ~
  Symfony\Component\Serializer\Serializer:
    arguments:
      -
        - '@ExEss\Cms\Component\Health\Serializer\Normalizer\HealthCheckResultNormalizer'
        - '@ExEss\Cms\Component\Client\Serializer\Normalizer\GuzzleResponseNormalizer'

  ExEss\Cms\ListFunctions\ListFunctions:
    arguments:
      - '@ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions'
      - '@ExEss\Cms\Api\V8_Custom\Repository\ListHandler'
      - '@ExEss\Cms\Service\ActionService'
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'
      - '@ExEss\Cms\Acl\AclService'
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Service\FilterService'

  ExEss\Cms\Parser\Translator\FatEntityTranslator:
    arguments:
      - '@service_container'

  ExEss\Cms\Parser\Translator\QueryTranslator:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Acl\AclService'

  ExEss\Cms\Parser\PathResolver:
    arguments:
      - '@ExEss\Cms\Parser\PathCompiler'
      -
        ExEss\Cms\Parser\Translator\FatEntityTranslator: '@ExEss\Cms\Parser\Translator\FatEntityTranslator'
        ExEss\Cms\Parser\Translator\QueryTranslator: '@ExEss\Cms\Parser\Translator\QueryTranslator'

  ExEss\Cms\Parser\ExpressionGroupParser:
    arguments:
      - '@ExEss\Cms\Parser\ExpressionParser'

  ExEss\Cms\Parser\ExpressionParser:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Parser\PathResolver'

  ExEss\Cms\Parser\PathCompiler:
    arguments:
      - '@=service(constant("ExEss\\Cms\\Cache\\Cache::COMPILER_PATHS"))'
      - '@ExEss\Cms\Parser\Compiler\ExternalObjectCompiler'
      - '@ExEss\Cms\Parser\Compiler\ObjectMethodCompiler'
      - '@ExEss\Cms\Parser\Compiler\ObjectPropertyCompiler'
      - '@ExEss\Cms\Parser\Compiler\ExternalLinkCompiler'
      - '@ExEss\Cms\Parser\Compiler\DateTimeCompiler'
      - '@ExEss\Cms\Parser\Compiler\SecurityCompiler'
      - '@ExEss\Cms\Parser\Compiler\RelationListCompiler'
      - '@ExEss\Cms\Parser\Compiler\AssociationCompiler'

  ExEss\Cms\Parser\Compiler\ExternalObjectCompiler: ~

  ExEss\Cms\Parser\Compiler\ObjectMethodCompiler: ~
  ExEss\Cms\Parser\Compiler\ObjectPropertyCompiler: ~
  ExEss\Cms\Parser\Compiler\AssociationCompiler:
    arguments:
      - '@doctrine.orm.entity_manager'

  ExEss\Cms\Parser\Compiler\ExternalLinkCompiler: ~
  ExEss\Cms\Parser\Compiler\DateTimeCompiler: ~
  ExEss\Cms\Parser\Compiler\SecurityCompiler: ~
  ExEss\Cms\Parser\Compiler\RelationListCompiler: ~

  ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@=service(constant("ExEss\\Cms\\Cache\\Cache::PARSED_QUERY_USER"))'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'
      - '@ExEss\Cms\MultiLevelTemplate\TextFunctionHandler'
      - '@ExEss\Cms\Parser\ExpressionGroupParser'

  JsonMapper:
    class: JsonMapper
    factory: [ExEss\Cms\Factory\JsonMapperFactory, create]

  ExEss\Cms\FLW_Flows\Builder\FormBuilder:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\FLW_Flows\Builder\EnumFieldBuilder'
      - '@ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions'
      - '@ExEss\Cms\FESelectWithSearch\SelectWithSearchService'
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'
      - '@ExEss\Cms\FLW_Flows\Field'

  ExEss\Cms\FLW_Flows\Field:
    arguments:
      - '%max_upload_file_size_mb%'

  ExEss\Cms\FLW_Flows\Builder\EnumFieldBuilder:
    lazy: true
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Logger\Logger'
      - '@ExEss\Cms\Api\V8_Custom\Repository\ListHandler'
      - '@ExEss\Cms\FLW_Flows\EnumRecordFactory'
      - '@ExEss\Cms\FESelectWithSearch\SelectWithSearchService'

  ExEss\Cms\ListFunctions\ListExportService:
    arguments:
      - '%env_url%'
      - '@ExEss\Cms\Api\V8_Custom\Service\FlashMessages\FlashMessageContainer'

  ExEss\Cms\Api\V8_Custom\Sidebar\SidebarFactory: ~

  ExEss\Cms\DASH_Dashboard\DashboardCalcFunctions: ~

  ExEss\Cms\FESelectWithSearch\SelectWithSearchService:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions'
      - '@ExEss\Cms\Api\V8_Custom\Repository\ListHandler'

  ExEss\Cms\Api\V8_Custom\Service\User\CommandService:
    arguments:
      - '@ExEss\Cms\Api\V8_Custom\Service\SimpleActionFactory'
      - '@ExEss\Cms\Api\V8_Custom\Service\User\RedirectPathCookieService'

  ExEss\Cms\Api\V8_Custom\Service\User\RedirectPathCookieService:
    arguments:
      - '@ExEss\Cms\Http\Cookies'

  ExEss\Cms\FieldFormatter\VatNumberFormatter: ~

  libphonenumber\PhoneNumberUtil:
    class: libphonenumber\PhoneNumberUtil
    factory: [libphonenumber\PhoneNumberUtil, getInstance]

  ExEss\Cms\FieldFormatter\PhoneNumberFormatter:
    arguments:
      - 'BE'
      - '@libphonenumber\PhoneNumberUtil'

  ExEss\Cms\FieldFormatter\IbanFormatter: ~

  ExEss\Cms\Api\V8_Custom\Service\SimpleActionFactory:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\Logger\Logger'
      - '@ExEss\Cms\Users\Service\GuidanceRecoveryService'

  ExEss\Cms\FLW_Flows\ActionFactory:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\FLW_Flows\Event\FlowEventDispatcher'
      - '@ExEss\Cms\Logger\Logger'
      - '@ExEss\Cms\Users\Service\GuidanceRecoveryService'
      - '@Symfony\Component\Translation\Translator'

  ExEss\Cms\FLW_Flows\EnumRecordFactory:
    arguments:
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\Api\V8_Custom\Service\Security'

  ExEss\Cms\Grid\RepeatableRowService:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@Symfony\Component\Translation\Translator'
      - '@ExEss\Cms\ListFunctions\HelperClasses\ListHelperFunctions'
      - '@ExEss\Cms\Servicemix\ExternalObjectHandler'

  ExEss\Cms\MultiLevelTemplate\TextFunctionHandler:
    arguments:
      - '@ExEss\Cms\Logger\Logger'
      - '@Symfony\Component\Translation\Translator'

  ExEss\Cms\CRUD\CrudService:
    arguments:
      - '@doctrine.orm.entity_manager'
      - '@ExEss\Cms\FLW_Flows\Builder\EnumFieldBuilder'

  # Autowired Service directory
  ExEss\Cms\Service\:
    public: true
    autowire: true
    resource: '../../src/ExEss/Cms/Service/'

imports:
  - { resource: 'api_client_external.yaml' }
  - { resource: 'api_client_internal.yaml' }
  - { resource: 'backendCommands.yaml' }
  - { resource: 'caches.yaml' }
  - { resource: 'commands.yaml' }
  - { resource: 'converters.yaml' }
  - { resource: 'database.yaml' }
  - { resource: 'handlers.yaml' }
  - { resource: 'health.yaml' }
  - { resource: 'logging.yaml' }
  - { resource: 'middleware.yaml' }
  - { resource: 'params.yaml' }
  - { resource: 'repositories.yaml' }
  - { resource: 'security.yaml' }
  - { resource: 'slim_defaults.yaml' }
  - { resource: 'subscribers.yaml' }
  - { resource: 'suggestions.yaml' }
  - { resource: 'translators.yaml' }
  - { resource: 'validation.yaml' }
  - { resource: 'controllers.yaml' }
  - { resource: 'relationships.yaml' }
  - { resource: 'entity_listeners.yaml' }
